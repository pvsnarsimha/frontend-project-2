<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAZIL Database Express Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* All the CSS styles from the original file remain unchanged */
        :root {
            --primary-color: #0067a5;
            --secondary-color: #005a8e;
            --border-color: #7f9db9;
            --bg-color: #f0f3f5;
            --text-color: #333;
            --panel-bg: white;
            --header-bg: linear-gradient(to bottom, #7f9db9, #6b8caa);
            --sidebar-bg: #e1e7ec;
            --status-bar-bg: linear-gradient(to bottom, #e1e7ec, #d0dde6);
        }

        .theme-dark {
            --primary-color: #4a90e2;
            --secondary-color: #3a70b2;
            --border-color: #5a6c7d;
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --panel-bg: #2d2d2d;
            --header-bg: linear-gradient(to bottom, #3a3a3a, #2d2d2d);
            --sidebar-bg: #252525;
            --status-bar-bg: linear-gradient(to bottom, #252525, #1f1f1f);
        }

        .theme-high-contrast {
            --primary-color: #000000;
            --secondary-color: #ffffff;
            --border-color: #ffeb3b;
            --bg-color: #000000;
            --text-color: #ffffff;
            --panel-bg: #121212;
            --header-bg: linear-gradient(to bottom, #000000, #222222);
            --sidebar-bg: #181818;
            --status-bar-bg: linear-gradient(to bottom, #000000, #222222);
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }
        .header {
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-tabs {
            background: linear-gradient(to bottom, #d0dde6, #b8c9d6);
            border-bottom: 1px solid var(--border-color);
            padding: 4px 10px 0;
        }
        .theme-dark .nav-tabs {
            background: linear-gradient(to bottom, #3a3a3a, #2d2d2d);
        }
        .theme-high-contrast .nav-tabs {
            background: linear-gradient(to bottom, #000000, #222222);
        }
        .nav-tab {
            background: linear-gradient(to bottom, #e9eef2, #d0dde6);
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 5px 15px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            margin-right: 3px;
            cursor: pointer;
            font-size: 13px;
        }
        .theme-dark .nav-tab {
            background: linear-gradient(to bottom, #3a3a3a, #2d2d2d);
            color: #e0e0e0;
        }
        .theme-high-contrast .nav-tab {
            background: linear-gradient(to bottom, #000000, #222222);
            color: #ffffff;
            border-color: #ffeb3b;
        }
        .nav-tab.active {
            background: var(--panel-bg);
            color: var(--primary-color);
            font-weight: bold;
        }
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            margin: 10px;
            border-radius: 3px;
        }
        .panel-header {
            background: var(--header-bg);
            color: white;
            padding: 6px 10px;
            font-weight: bold;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-content {
            padding: 12px;
        }
        .button {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        .button:hover {
            background: linear-gradient(to bottom, #e6e6e6, #d6d6d6);
        }
        .theme-dark .button {
            background: linear-gradient(to bottom, #3a3a3a, #2d2d2d);
            color: #e0e0e0;
        }
        .theme-high-contrast .button {
            background: linear-gradient(to bottom, #000000, #222222);
            color: #ffffff;
            border-color: #ffeb3b;
        }
        .button-primary {
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid var(--border-color);
        }
        .button-primary:hover {
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
        }
        .sql-input {
            border: 1px solid var(--border-color);
            padding: 8px;
            background-color: var(--panel-bg);
            color: var(--text-color);
            font-family: monospace;
            font-size: 13px;
            width: 100%;
            box-sizing: border-box;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .table th {
            background: linear-gradient(to bottom, #e1e7ec, #d0dde6);
            color: var(--text-color);
            padding: 5px;
            border: 1px solid var(--border-color);
            text-align: left;
            font-weight: bold;
        }
        .theme-dark .table th {
            background: linear-gradient(to bottom, #3a3a3a, #2d2d2d);
        }
        .theme-high-contrast .table th {
            background: linear-gradient(to bottom, #000000, #222222);
            border-color: #ffeb3b;
        }
        .table td {
            padding: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--panel-bg);
        }
        .table tr:nth-child(even) td {
            background-color: #f7f9fb;
        }
        .theme-dark .table tr:nth-child(even) td {
            background-color: #353535;
        }
        .theme-high-contrast .table tr:nth-child(even) td {
            background-color: #1a1a1a;
        }
        .sidebar {
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            width: 200px;
        }
        .sidebar-item {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 12px;
        }
        .sidebar-item:hover {
            background-color: #d0dde6;
        }
        .theme-dark .sidebar-item:hover {
            background-color: #3a3a3a;
        }
        .theme-high-contrast .sidebar-item:hover {
            background-color: #000000;
        }
        .status-bar {
            background: var(--status-bar-bg);
            border-top: 1px solid var(--border-color);
            padding: 4px 10px;
            font-size: 12px;
            color: var(--text-color);
        }
        pre { 
            background: #2d2d2d; 
            color: #f8f8f2; 
            padding: 10px; 
            border-radius: 3px; 
            font-size: 12px;
        }
        .tooltip { 
            position: relative; 
            display: inline-block; 
        }
        .tooltip .tooltiptext { 
            visibility: hidden; 
            width: 120px; 
            background-color: #555; 
            color: #fff; 
            text-align: center; 
            border-radius: 4px; 
            padding: 5px; 
            position: absolute; 
            z-index: 1; 
            bottom: 125%; 
            left: 50%; 
            margin-left: -60px; 
            opacity: 0; 
            transition: opacity 0.3s; 
            font-size: 11px;
        }
        .tooltip:hover .tooltiptext { 
            visibility: visible; 
            opacity: 1; 
        }
        .query-examples {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .breadcrumb {
            font-size: 12px;
            color: #666;
            padding: 5px 15px;
            background-color: #f7f9fb;
            border-bottom: 1px solid var(--border-color);
        }
        .theme-dark .breadcrumb {
            background-color: #353535;
            color: #e0e0e0;
        }
        .theme-high-contrast .breadcrumb {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .constraint-examples {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }
        .subquery-examples {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }
        .error-message {
            color: #d00;
            background-color: #ffeeee;
            padding: 8px;
            border-radius: 3px;
            margin: 5px 0;
            font-size: 12px;
        }
        .success-message {
            color: #007700;
            background-color: #eeffee;
            padding: 8px;
            border-radius: 3px;
            margin: 5px 0;
            font-size: 12px;
        }
        
        /* Resizable panels */
        .resizable {
            resize: both;
            overflow: auto;
            min-height: 100px;
            min-width: 150px;
        }
        
        /* Drag and drop */
        .draggable {
            cursor: move;
        }
        
        /* Full screen mode */
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: var(--panel-bg);
        }
        
        /* Query builder */
        .query-builder {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* Tabs */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Chart container */
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        /* Query Builder Styles */
        .selected-table {
            background-color: #cce5ff !important;
        }
        .theme-dark .selected-table {
            background-color: #2c5282 !important;
        }
        .theme-high-contrast .selected-table {
            background-color: #ffff00 !important;
            color: #000000 !important;
        }
        .query-builder-section {
            margin-bottom: 10px;
        }
        .query-builder-section h4 {
            margin: 5px 0;
            font-weight: bold;
        }
        .condition-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            margin: 3px 0;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .theme-dark .condition-item {
            background-color: #3a3a3a;
        }
        .theme-high-contrast .condition-item {
            background-color: #222222;
        }
        
        /* New styles for logical operators */
        .logical-operator {
            margin: 5px 0;
            padding: 3px;
            background-color: #e6f7ff;
            border-radius: 3px;
            text-align: center;
            font-weight: bold;
        }
        .theme-dark .logical-operator {
            background-color: #2c5282;
        }
        .theme-high-contrast .logical-operator {
            background-color: #ffff00;
            color: #000000;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <div class="header">
        <div>CRAZIL Database Express Edition</div>
        <div class="flex items-center space-x-2">
            <select id="themeSelector" class="text-black text-xs p-1 rounded" onchange="changeTheme(this.value)">
                <option value="light">Light Theme</option>
                <option value="dark">Dark Theme</option>
                <option value="high-contrast">High Contrast</option>
            </select>
            <button class="button text-xs" onclick="toggleFullScreen()">Full Screen</button>
            <button class="button text-xs" onclick="showSettings()">Settings</button>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        Name > SQL > SQL Command Line
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <span class="nav-tab active" onclick="switchTab('sql')">SQL</span>
        <span class="nav-tab" onclick="switchTab('results')">Results</span>
        <span class="nav-tab" onclick="switchTab('explain')">Explain Plan</span>
        <span class="nav-tab" onclick="switchTab('history')">SQL History</span>
        <span class="nav-tab" onclick="switchTab('saved')">Saved SQL</span>
        <span class="nav-tab" onclick="switchTab('builder')">Query Builder</span>
        <span class="nav-tab" onclick="switchTab('charts')">Charts</span>
    </div>

    <!-- Main Content -->
    <div class="flex flex-1">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="panel">
                <div class="panel-header">Objects</div>
                <div class="panel-content p-0" id="objectsList">
                    <div class="sidebar-item" onclick="showTable('employees')">EMPLOYEES</div>
                    <div class="sidebar-item" onclick="showTable('departments')">DEPARTMENTS</div>
                    <div class="sidebar-item" onclick="showTable('projects')">PROJECTS</div>
                </div>
            </div>
            
            <div class="panel mt-3">
                <div class="panel-header">History</div>
                <div class="panel-content p-0" id="queryHistory">
                    <div class="sidebar-item">No queries yet</div>
                </div>
            </div>
            
            <div class="panel mt-3">
                <div class="panel-header">Saved Queries</div>
                <div class="panel-content p-0" id="savedQueries">
                    <div class="sidebar-item">No saved queries</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- SQL Tab -->
            <div id="sql-tab" class="tab-content active">
                <!-- Query Tabs -->
                <div class="mx-2 mt-2 flex border-b border-gray-300" id="queryTabsContainer">
                    <div class="px-4 py-2 bg-gray-200 border border-b-0 border-gray-300 rounded-t cursor-pointer font-medium" onclick="switchQueryTab(0)">
                        Query 1
                    </div>
                    <div class="px-4 py-2 border-b border-gray-300 cursor-pointer" onclick="addNewQueryTab()">
                        +
                    </div>
                </div>

                <!-- Query Area -->
                <div class="panel mx-2 mt-0">
                    <div class="panel-header">
                        Enter SQL Statement
                        <div class="float-right">
                            <button class="button button-primary" onclick="executeQuery()">Run</button>
                            <button class="button" onclick="saveQuery()">Save</button>
                        </div>
                    </div>
                    <div class="panel-content p-0">
                        <textarea id="sqlQuery0" rows="6" class="sql-input" oninput="highlightQuery(0)" placeholder="Enter SQL statement or PL/SQL command and click Run to see the results."></textarea>
                    </div>
                </div>

                <!-- Predefined Queries -->
                <div class="panel mx-2 mt-2">
                    <div class="panel-header">Example Queries</div>
                    <div class="panel-content">
                        <div class="query-examples">
                            <button onclick="runExample('create')" class="button tooltip">
                                <span>Create Tables</span>
                                <span class="tooltiptext">Create employees and departments</span>
                            </button>
                            <button onclick="runExample('insert')" class="button tooltip">
                                <span>INSERT</span>
                                <span class="tooltiptext">Insert sample data</span>
                            </button>
                            <button onclick="runExample('select')" class="button tooltip">
                                <span>SELECT</span>
                                <span class="tooltiptext">Select with conditions</span>
                            </button>
                            <button onclick="runExample('update')" class="button tooltip">
                                <span>UPDATE</span>
                                <span class="tooltiptext">Update salaries</span>
                            </button>
                            <button onclick="runExample('delete')" class="button tooltip">
                                <span>DELETE</span>
                                <span class="tooltiptext">Delete records</span>
                            </button>
                            <button onclick="runExample('drop')" class="button tooltip">
                                <span>DROP</span>
                                <span class="tooltiptext">Drop tables</span>
                            </button>
                            <button onclick="runExample('alter')" class="button tooltip">
                                <span>ALTER</span>
                                <span class="tooltiptext">Add column</span>
                            </button>
                            <button onclick="runExample('truncate')" class="button tooltip">
                                <span>TRUNCATE</span>
                                <span class="tooltiptext">Clear table data</span>
                            </button>
                            <button onclick="runExample('merge')" class="button tooltip">
                                <span>MERGE</span>
                                <span class="tooltiptext">Upsert operation</span>
                            </button>
                            <button onclick="runExample('join')" class="button tooltip">
                                <span>JOIN</span>
                                <span class="tooltiptext">Join tables</span>
                            </button>
                            <button onclick="runExample('case')" class="button tooltip">
                                <span>CASE</span>
                                <span class="tooltiptext">Conditional logic</span>
                            </button>
                            <button onclick="runExample('aggregate')" class="button tooltip">
                                <span>AGGREGATE</span>
                                <span class="tooltiptext">Count, Sum, etc.</span>
                            </button>
                        </div>
                        
                        <div class="constraint-examples">
                            <button onclick="runExample('not_null')" class="button tooltip">
                                <span>NOT NULL</span>
                                <span class="tooltiptext">NOT NULL constraint</span>
                            </button>
                            <button onclick="runExample('unique')" class="button tooltip">
                                <span>UNIQUE</span>
                                <span class="tooltiptext">UNIQUE constraint</span>
                            </button>
                            <button onclick="runExample('primary')" class="button tooltip">
                                <span>PRIMARY KEY</span>
                                <span class="tooltiptext">PRIMARY KEY constraint</span>
                            </button>
                            <button onclick="runExample('foreign')" class="button tooltip">
                                <span>FOREIGN KEY</span>
                                <span class="tooltiptext">FOREIGN KEY constraint</span>
                            </button>
                            <button onclick="runExample('check')" class="button tooltip">
                                <span>CHECK</span>
                                <span class="tooltiptext">CHECK constraint</span>
                            </button>
                            <button onclick="runExample('default')" class="button tooltip">
                                <span>DEFAULT</span>
                                <span class="tooltiptext">DEFAULT constraint</span>
                            </button>
                            <button onclick="runExample('auto_increment')" class="button tooltip">
                                <span>AUTO INCREMENT</span>
                                <span class="tooltiptext">AUTO INCREMENT field</span>
                            </button>
                        </div>
                        
                        <div class="subquery-examples">
                            <button onclick="runExample('subquery_where')" class="button tooltip">
                                <span>WHERE Subquery</span>
                                <span class="tooltiptext">Subquery in WHERE clause</span>
                            </button>
                            <button onclick="runExample('subquery_select')" class="button tooltip">
                                <span>SELECT Subquery</span>
                                <span class="tooltiptext">Subquery in SELECT clause</span>
                            </button>
                            <button onclick="runExample('subquery_from')" class="button tooltip">
                                <span>FROM Subquery</span>
                                <span class="tooltiptext">Subquery in FROM clause</span>
                            </button>
                            <button onclick="runExample('subquery_exists')" class="button tooltip">
                                <span>EXISTS</span>
                                <span class="tooltiptext">EXISTS subquery</span>
                            </button>
                            <button onclick="runExample('subquery_in')" class="button tooltip">
                                <span>IN Subquery</span>
                                <span class="tooltiptext">IN with subquery</span>
                            </button>
                            <button onclick="runExample('subquery_correlated')" class="button tooltip">
                                <span>Correlated</span>
                                <span class="tooltiptext">Correlated subquery</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results-tab" class="tab-content">
                <!-- Results Area -->
                <div class="panel mx-2 mt-2 flex-1">
                    <div class="panel-header">
                        Results
                        <div>
                            <button class="button" onclick="exportData('csv')">Export CSV</button>
                            <button class="button" onclick="exportData('json')">Export JSON</button>
                            <button class="button" onclick="exportData('excel')">Export Excel</button>
                            <button class="button" onclick="exportData('pdf')">Export PDF</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div id="output" class="text-sm">No data to display. Execute a query to see results.</div>
                    </div>
                </div>

                <!-- Table Preview -->
                <div class="panel mx-2 mt-2 mb-2 flex-1">
                    <div class="panel-header">Data Preview</div>
                    <div class="panel-content">
                        <div id="tablePreview" class="text-sm">No table selected. Click on a table name in the Objects panel.</div>
                    </div>
                </div>
            </div>

            <!-- Explain Plan Tab -->
            <div id="explain-tab" class="tab-content">
                <div class="panel mx-2 mt-2">
                    <div class="panel-header">Explain Plan</div>
                    <div class="panel-content">
                        <div id="explainOutput">No explain plan generated yet.</div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="panel mx-2 mt-2">
                    <div class="panel-header">Query History</div>
                    <div class="panel-content">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>

            <!-- Saved SQL Tab -->
            <div id="saved-tab" class="tab-content">
                <div class="panel mx-2 mt-2">
                    <div class="panel-header">Saved Queries</div>
                    <div class="panel-content">
                        <div id="savedList"></div>
                    </div>
                </div>
            </div>

            <!-- Query Builder Tab -->
            <div id="builder-tab" class="tab-content">
                <div class="panel mx-2 mt-2">
                    <div class="panel-header">Visual Query Builder</div>
                    <div class="panel-content">
                        <div class="query-builder">
                            <div class="query-builder-section">
                                <h4>Tables</h4>
                                <div id="tablesList" class="border p-2 h-40 overflow-auto">
                                    <div class="text-sm text-gray-500">No tables found. Create tables first.</div>
                                </div>
                                <button class="button mt-2" onclick="refreshQueryBuilder()">Refresh Tables</button>
                            </div>
                            
                            <div class="query-builder-section">
                                <h4>Columns</h4>
                                <div id="columnsList" class="border p-2 h-40 overflow-auto">
                                    <div class="text-sm text-gray-500">Select a table first</div>
                                </div>
                            </div>
                            
                            <div class="query-builder-section">
                                <h4>Conditions</h4>
                                <div class="border p-2">
                                    <div class="mb-2">
                                        <select id="conditionColumn" class="sql-input mb-2 w-full">
                                            <option value="">-- Select Column --</option>
                                        </select>
                                        <select id="conditionOperator" class="sql-input mb-2 w-full">
                                            <option value="=">=</option>
                                            <option value="!=">!=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                                            <option value="<"><</option>
                                            <option value="<="><=</option>
                                            <option value="LIKE">LIKE</option>
                                            <option value="NOT LIKE">NOT LIKE</option>
                                            <option value="IN">IN</option>
                                            <option value="NOT IN">NOT IN</option>
                                            <option value="IS NULL">IS NULL</option>
                                            <option value="IS NOT NULL">IS NOT NULL</option>
                                        </select>
                                        <input type="text" id="conditionValue" placeholder="Value" class="sql-input mb-2 w-full">
                                        <div class="flex space-x-2 mb-2">
                                            <button class="button flex-1" onclick="addCondition('AND')">Add AND Condition</button>
                                            <button class="button flex-1" onclick="addCondition('OR')">Add OR Condition</button>
                                        </div>
                                    </div>
                                    <div id="conditionsList" class="mt-2 max-h-32 overflow-auto"></div>
                                </div>
                            </div>
                            
                            <div class="query-builder-section">
                                <h4>Sorting</h4>
                                <div class="border p-2">
                                    <select id="sortColumn" class="sql-input mb-2 w-full">
                                        <option value="">-- Select Column --</option>
                                    </select>
                                    <select id="sortDirection" class="sql-input mb-2 w-full">
                                        <option value="ASC">Ascending</option>
                                        <option value="DESC">Descending</option>
                                    </select>
                                    <button class="button w-full" onclick="addSort()">Add Sort</button>
                                    <div id="sortList" class="mt-2 max-h-32 overflow-auto"></div>
                                </div>
                            </div>
                            
                            <div class="query-builder-section">
                                <h4>Generated SQL</h4>
                                <textarea id="generatedSql" class="sql-input h-40" readonly></textarea>
                                <div class="flex space-x-2 mt-2">
                                    <button class="button button-primary flex-1" onclick="useGeneratedSql()">Use This Query</button>
                                    <button class="button flex-1" onclick="executeGeneratedSql()">Run This Query</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Tab -->
            <div id="charts-tab" class="tab-content">
                <div class="panel mx-2 mt-2">
                    <div class="panel-header">Chart Visualization</div>
                    <div class="panel-content">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Select Table</label>
                                <select id="chartTable" class="sql-input w-full" onchange="updateChartColumns()">
                                    <option value="">-- Select Table --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Chart Type</label>
                                <select id="chartType" class="sql-input w-full">
                                    <option value="bar">Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="doughnut">Doughnut Chart</option>
                                    <option value="scatter">Scatter Plot</option>
                                    <option value="polarArea">Polar Area</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Label Column (X-axis)</label>
                                <select id="labelColumn" class="sql-input w-full">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Data Column (Y-axis)</label>
                                <select id="dataColumn" class="sql-input w-full">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button class="button button-primary" onclick="generateChart()">Generate Chart</button>
                            <button class="button" onclick="clearChart()">Clear Chart</button>
                        </div>
                        
                        <div class="chart-container mt-4">
                            <canvas id="dataChart"></canvas>
                        </div>
                        
                        <div id="chartError" class="error-message mt-4 hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="statusMessage">Ready</span>
        <span class="float-right">Press Ctrl+Enter to execute query</span>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="panel w-1/2">
            <div class="panel-header">Settings</div>
            <div class="panel-content">
                <h3 class="font-bold mb-2">Keyboard Shortcuts</h3>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div>Execute Query:</div>
                    <div><input type="text" class="sql-input" value="Ctrl+Enter" readonly></div>
                    <div>New Tab:</div>
                    <div><input type="text" class="sql-input" value="Ctrl+T" readonly></div>
                    <div>Save Query:</div>
                    <div><input type="text" class="sql-input" value="Ctrl+S" readonly></div>
                </div>
                <h3 class="font-bold mb-2">Panel Layout</h3>
                <div class="mb-4">
                    <button class="button" onclick="resetLayout()">Reset Layout</button>
                </div>
                <div class="flex justify-end">
                    <button class="button button-primary" onclick="document.getElementById('settingsModal').classList.add('hidden')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let queryHistory = [];
        let savedQueries = [];
        let currentQueryTab = 0;
        let queryTabs = [''];
        let chart = null;
        let selectedTable = null;
        let queryBuilderConditions = [];
        let queryBuilderSorts = [];

        // Initialize the database
        async function initDB() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                db = new SQL.Database();
                updateStatus("Database initialized successfully.");
                updateObjectsList();
                updateQueryBuilderTables();
                updateChartTableList();
            } catch (error) {
                updateStatus("Error initializing database: " + error.message);
            }
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function displayTable(results, target = 'output') {
            if (!results || !results[0] || !results[0].values.length) {
                document.getElementById(target).innerHTML = '<div class="p-2">No results found.</div>';
                return;
            }
            
            let html = '<table class="table"><tr>';
            results[0].columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr>';
            results[0].values.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${cell ?? 'NULL'}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            document.getElementById(target).innerHTML = html;
        }

        function executeQuery() {
            const query = document.getElementById(`sqlQuery${currentQueryTab}`).value.trim();
            if (!query) {
                updateStatus("No query to execute.");
                return;
            }
            
            try {
                const results = db.exec(query);
                displayTable(results);
                addToHistory(query);
                updateStatus("Query executed successfully.");
                switchTab('results');
            } catch (error) {
                document.getElementById('output').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                updateStatus("Error executing query: " + error.message);
            }
        }

        function addToHistory(query) {
            queryHistory.unshift({
                query,
                timestamp: new Date().toLocaleString()
            });
            
            if (queryHistory.length > 50) {
                queryHistory.pop();
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            queryHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 border-b border-gray-200 cursor-pointer hover:bg-gray-100';
                div.innerHTML = `
                    <div class="text-xs text-gray-500">${item.timestamp}</div>
                    <div class="text-sm truncate">${item.query}</div>
                `;
                div.onclick = () => {
                    document.getElementById(`sqlQuery${currentQueryTab}`).value = item.query;
                    switchTab('sql');
                };
                historyList.appendChild(div);
            });
        }

        function saveQuery() {
            const query = document.getElementById(`sqlQuery${currentQueryTab}`).value.trim();
            if (!query) {
                updateStatus("No query to save.");
                return;
            }
            
            const name = prompt("Enter a name for this query:");
            if (!name) return;
            
            savedQueries.push({
                name,
                query,
                timestamp: new Date().toLocaleString()
            });
            
            updateSavedQueriesDisplay();
            updateStatus("Query saved successfully.");
        }

        function updateSavedQueriesDisplay() {
            const savedList = document.getElementById('savedList');
            savedList.innerHTML = '';
            
            savedQueries.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 border-b border-gray-200 cursor-pointer hover:bg-gray-100';
                div.innerHTML = `
                    <div class="font-bold">${item.name}</div>
                    <div class="text-xs text-gray-500">${item.timestamp}</div>
                    <div class="text-sm truncate">${item.query}</div>
                `;
                div.onclick = () => {
                    document.getElementById(`sqlQuery${currentQueryTab}`).value = item.query;
                    switchTab('sql');
                };
                savedList.appendChild(div);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.nav-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        function addNewQueryTab() {
            const tabCount = queryTabs.length;
            const newTabIndex = tabCount;
            queryTabs.push('');
            
            const tabsContainer = document.getElementById('queryTabsContainer');
            const newTab = document.createElement('div');
            newTab.className = 'px-4 py-2 bg-gray-200 border border-b-0 border-gray-300 rounded-t cursor-pointer';
            newTab.textContent = `Query ${tabCount + 1}`;
            newTab.onclick = () => switchQueryTab(newTabIndex);
            tabsContainer.insertBefore(newTab, tabsContainer.lastElementChild);
            
            const queryArea = document.getElementById('sql-tab');
            const newTextarea = document.createElement('textarea');
            newTextarea.id = `sqlQuery${newTabIndex}`;
            newTextarea.className = 'sql-input';
            newTextarea.rows = 6;
            newTextarea.placeholder = "Enter SQL statement or PL/SQL command and click Run to see the results.";
            newTextarea.oninput = () => highlightQuery(newTabIndex);
            
            const panelContent = document.querySelector('#sql-tab .panel-content');
            panelContent.appendChild(newTextarea);
            
            switchQueryTab(newTabIndex);
        }

        function switchQueryTab(index) {
            currentQueryTab = index;
            const tabs = document.querySelectorAll('#queryTabsContainer > div');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.className = 'px-4 py-2 bg-gray-200 border border-b-0 border-gray-300 rounded-t cursor-pointer font-medium';
                } else if (i < tabs.length - 1) {
                    tab.className = 'px-4 py-2 border-b border-gray-300 cursor-pointer';
                }
            });
            
            document.querySelectorAll('#sql-tab textarea').forEach((ta, i) => {
                if (i === index) {
                    ta.classList.remove('hidden');
                } else {
                    ta.classList.add('hidden');
                }
            });
        }

        function runExample(type) {
            let query = '';
            switch (type) {
                case 'create':
                    query = `CREATE TABLE employees (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    department TEXT,
    salary REAL,
    hire_date TEXT
);

CREATE TABLE departments (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    location TEXT
);

CREATE TABLE projects (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    budget REAL,
    status TEXT
);`;
                    break;
                case 'insert':
                    query = `INSERT INTO employees (id, name, department, salary, hire_date) VALUES
(1, 'John Doe', 'IT', 75000, '2020-01-15'),
(2, 'Jane Smith', 'HR', 65000, '2019-03-22'),
(3, 'Robert Johnson', 'IT', 82000, '2018-06-10'),
(4, 'Emily Davis', 'Marketing', 70000, '2021-09-05'),
(5, 'Michael Brown', 'Sales', 90000, '2017-11-30');

INSERT INTO departments (id, name, location) VALUES
(1, 'IT', 'New York'),
(2, 'HR', 'Chicago'),
(3, 'Marketing', 'Los Angeles'),
(4, 'Sales', 'Boston');

INSERT INTO projects (id, name, budget, status) VALUES
(1, 'Website Redesign', 50000, 'Completed'),
(2, 'Employee Portal', 75000, 'In Progress'),
(3, 'Marketing Campaign', 100000, 'Planning'),
(4, 'Sales Training', 25000, 'Completed');`;
                    break;
                case 'select':
                    query = 'SELECT * FROM employees WHERE department = "IT" ORDER BY salary DESC;';
                    break;
                case 'update':
                    query = 'UPDATE employees SET salary = salary * 1.1 WHERE department = "IT";';
                    break;
                case 'delete':
                    query = 'DELETE FROM employees WHERE id = 5;';
                    break;
                case 'drop':
                    query = 'DROP TABLE employees;';
                    break;
                case 'alter':
                    query = 'ALTER TABLE employees ADD COLUMN email TEXT;';
                    break;
                case 'truncate':
                    query = 'DELETE FROM employees;';
                    break;
                case 'merge':
                    query = 'INSERT OR REPLACE INTO employees (id, name, department, salary) VALUES (1, "John Doe", "IT", 80000);';
                    break;
                case 'join':
                    query = 'SELECT e.name, e.department, d.location FROM employees e JOIN departments d ON e.department = d.name;';
                    break;
                case 'case':
                    query = 'SELECT name, salary, CASE WHEN salary > 80000 THEN "High" WHEN salary > 65000 THEN "Medium" ELSE "Low" END AS salary_grade FROM employees;';
                    break;
                case 'aggregate':
                    query = 'SELECT department, COUNT(*) as employee_count, AVG(salary) as avg_salary FROM employees GROUP BY department;';
                    break;
                case 'not_null':
                    query = 'CREATE TABLE test_table (id INTEGER NOT NULL, name TEXT);';
                    break;
                case 'unique':
                    query = 'CREATE TABLE test_table (id INTEGER UNIQUE, name TEXT);';
                    break;
                case 'primary':
                    query = 'CREATE TABLE test_table (id INTEGER PRIMARY KEY, name TEXT);';
                    break;
                case 'foreign':
                    query = 'CREATE TABLE orders (id INTEGER PRIMARY KEY, employee_id INTEGER, FOREIGN KEY(employee_id) REFERENCES employees(id));';
                    break;
                case 'check':
                    query = 'CREATE TABLE test_table (id INTEGER, age INTEGER CHECK(age >= 18));';
                    break;
                case 'default':
                    query = 'CREATE TABLE test_table (id INTEGER, created_date TEXT DEFAULT CURRENT_DATE);';
                    break;
                case 'auto_increment':
                    query = 'CREATE TABLE test_table (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT);';
                    break;
                case 'subquery_where':
                    query = 'SELECT * FROM employees WHERE salary > (SELECT AVG(salary) FROM employees);';
                    break;
                case 'subquery_select':
                    query = 'SELECT name, salary, (SELECT AVG(salary) FROM employees) as avg_salary FROM employees;';
                    break;
                case 'subquery_from':
                    query = 'SELECT dept, avg_sal FROM (SELECT department as dept, AVG(salary) as avg_sal FROM employees GROUP BY department);';
                    break;
                case 'subquery_exists':
                    query = 'SELECT * FROM departments d WHERE EXISTS (SELECT 1 FROM employees e WHERE e.department = d.name);';
                    break;
                case 'subquery_in':
                    query = 'SELECT * FROM employees WHERE department IN (SELECT name FROM departments WHERE location = "New York");';
                    break;
                case 'subquery_correlated':
                    query = 'SELECT name, salary, department FROM employees e1 WHERE salary > (SELECT AVG(salary) FROM employees e2 WHERE e2.department = e1.department);';
                    break;
            }
            
            document.getElementById(`sqlQuery${currentQueryTab}`).value = query;
            highlightQuery(currentQueryTab);
            updateStatus(`Loaded ${type} example.`);
        }

        function showTable(tableName) {
            try {
                const results = db.exec(`SELECT * FROM ${tableName}`);
                displayTable(results, 'tablePreview');
                document.getElementById('tablePreview').previousElementSibling.querySelector('.panel-header').textContent = `Data Preview: ${tableName}`;
                updateStatus(`Displaying data from ${tableName}`);
            } catch (error) {
                document.getElementById('tablePreview').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                updateStatus("Error displaying table: " + error.message);
            }
        }

        function updateObjectsList() {
            try {
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                if (tables.length && tables[0].values.length) {
                    let html = '';
                    tables[0].values.forEach(row => {
                        html += `<div class="sidebar-item" onclick="showTable('${row[0]}')">${row[0]}</div>`;
                    });
                    document.getElementById('objectsList').innerHTML = html;
                }
            } catch (error) {
                console.error("Error updating objects list:", error);
            }
        }

        function exportData(format) {
            const query = document.getElementById(`sqlQuery${currentQueryTab}`).value.trim();
            if (!query) {
                updateStatus("No query to export.");
                return;
            }
            
            try {
                const results = db.exec(query);
                if (!results || !results[0] || !results[0].values.length) {
                    updateStatus("No data to export.");
                    return;
                }
                
                let data, mimeType, fileName;
                
                if (format === 'csv') {
                    // Convert to CSV
                    const headers = results[0].columns.join(',');
                    const rows = results[0].values.map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    );
                    data = [headers, ...rows].join('\n');
                    mimeType = 'text/csv';
                    fileName = 'data.csv';
                } else if (format === 'json') {
                    // Convert to JSON
                    const jsonData = results[0].values.map(row => {
                        const obj = {};
                        results[0].columns.forEach((col, i) => {
                            obj[col] = row[i];
                        });
                        return obj;
                    });
                    data = JSON.stringify(jsonData, null, 2);
                    mimeType = 'application/json';
                    fileName = 'data.json';
                } else if (format === 'excel') {
                    updateStatus("Excel export requires additional libraries. Exporting as CSV instead.");
                    const headers = results[0].columns.join(',');
                    const rows = results[0].values.map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    );
                    data = [headers, ...rows].join('\n');
                    mimeType = 'text/csv';
                    fileName = 'data.csv';
                } else if (format === 'pdf') {
                    updateStatus("PDF export requires additional libraries. Exporting as CSV instead.");
                    const headers = results[0].columns.join(',');
                    const rows = results[0].values.map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    );
                    data = [headers, ...rows].join('\n');
                    mimeType = 'text/csv';
                    fileName = 'data.csv';
                }
                
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateStatus(`Data exported as ${format.toUpperCase()}`);
            } catch (error) {
                document.getElementById('output').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                updateStatus("Error exporting data: " + error.message);
            }
        }

        function highlightQuery(index) {
            // This is a simplified version - in a real app you'd use a library like CodeMirror or Monaco
            const textarea = document.getElementById(`sqlQuery${index}`);
            const sql = textarea.value;
            
            // Simple keyword highlighting
            const keywords = [
                'SELECT', 'FROM', 'WHERE', 'INSERT', 'INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE', 
                'CREATE', 'TABLE', 'ALTER', 'DROP', 'TRUNCATE', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 
                'OUTER', 'ON', 'GROUP BY', 'ORDER BY', 'HAVING', 'AS', 'AND', 'OR', 'NOT', 'NULL',
                'LIKE', 'IN', 'EXISTS', 'BETWEEN', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'DISTINCT',
                'UNION', 'ALL', 'ANY', 'SOME', 'LIMIT', 'OFFSET', 'PRIMARY', 'KEY', 'FOREIGN', 'REFERENCES',
                'UNIQUE', 'INDEX', 'AUTOINCREMENT', 'DEFAULT', 'CHECK', 'CONSTRAINT', 'VIEW', 'TRIGGER',
                'PROCEDURE', 'FUNCTION', 'BEGIN', 'COMMIT', 'ROLLBACK', 'TRANSACTION', 'EXPLAIN', 'EXECUTE',
                'GRANT', 'REVOKE', 'VARCHAR', 'INTEGER', 'REAL', 'TEXT', 'BLOB', 'DATE', 'DATETIME', 'BOOLEAN'
            ];
            
            let highlighted = sql;
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                highlighted = highlighted.replace(regex, `<span class="text-blue-600 font-bold">${keyword}</span>`);
            });
            
            // Numbers
            highlighted = highlighted.replace(/\b\d+\b/g, '<span class="text-green-600">$&</span>');
            
            // Strings
            highlighted = highlighted.replace(/'[^']*'/g, '<span class="text-red-600">$&</span>');
            
            // Comments
            highlighted = highlighted.replace(/--.*$/gm, '<span class="text-gray-500">$&</span>');
            
            // Create a temporary div to hold the highlighted content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<pre>${highlighted}</pre>`;
            
            // Position the div exactly over the textarea
            const rect = textarea.getBoundingClientRect();
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = rect.left + 'px';
            tempDiv.style.top = rect.top + 'px';
            tempDiv.style.width = rect.width + 'px';
            tempDiv.style.height = rect.height + 'px';
            tempDiv.style.backgroundColor = getComputedStyle(textarea).backgroundColor;
            tempDiv.style.border = getComputedStyle(textarea).border;
            tempDiv.style.padding = getComputedStyle(textarea).padding;
            tempDiv.style.fontFamily = getComputedStyle(textarea).fontFamily;
            tempDiv.style.fontSize = getComputedStyle(textarea).fontSize;
            tempDiv.style.lineHeight = getComputedStyle(textarea).lineHeight;
            tempDiv.style.overflow = 'auto';
            tempDiv.style.zIndex = '10';
            tempDiv.style.pointerEvents = 'none';
            
            // Add to document
            document.body.appendChild(tempDiv);
            
            // Remove after a short delay
            setTimeout(() => {
                document.body.removeChild(tempDiv);
            }, 100);
        }

        function changeTheme(theme) {
            document.body.className = '';
            if (theme === 'dark') {
                document.body.classList.add('theme-dark');
            } else if (theme === 'high-contrast') {
                document.body.classList.add('theme-high-contrast');
            }
            localStorage.setItem('theme', theme);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    updateStatus(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function resetLayout() {
            localStorage.removeItem('layout');
            updateStatus("Layout reset. Refresh to see changes.");
        }

        // Query Builder Functions
        function refreshQueryBuilder() {
            updateQueryBuilderTables();
        }

        function updateQueryBuilderTables() {
            try {
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                const tablesList = document.getElementById('tablesList');
                
                if (tables.length && tables[0].values.length) {
                    tablesList.innerHTML = '';
                    tables[0].values.forEach(row => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b cursor-pointer hover:bg-gray-100';
                        div.textContent = row[0];
                        div.onclick = () => selectTableForQueryBuilder(row[0]);
                        tablesList.appendChild(div);
                    });
                } else {
                    tablesList.innerHTML = '<div class="text-sm text-gray-500">No tables found. Create tables first.</div>';
                }
            } catch (error) {
                console.error("Error updating query builder tables:", error);
            }
        }

        function selectTableForQueryBuilder(tableName) {
            selectedTable = tableName;
            
            // Highlight selected table
            document.querySelectorAll('#tablesList > div').forEach(div => {
                if (div.textContent === tableName) {
                    div.classList.add('selected-table');
                } else {
                    div.classList.remove('selected-table');
                }
            });
            
            // Update columns list
            updateQueryBuilderColumns(tableName);
            
            // Update condition and sort dropdowns
            updateConditionAndSortDropdowns(tableName);
            
            // Generate SQL
            generateQueryBuilderSql();
        }

        function updateQueryBuilderColumns(tableName) {
            try {
                const columnsInfo = db.exec(`PRAGMA table_info(${tableName})`);
                const columnsList = document.getElementById('columnsList');
                
                if (columnsInfo.length && columnsInfo[0].values.length) {
                    columnsList.innerHTML = '';
                    columnsInfo[0].values.forEach(row => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b cursor-pointer hover:bg-gray-100';
                        div.textContent = `${row[1]} (${row[2]})`;
                        columnsList.appendChild(div);
                    });
                } else {
                    columnsList.innerHTML = '<div class="text-sm text-gray-500">No columns found.</div>';
                }
            } catch (error) {
                console.error("Error updating query builder columns:", error);
            }
        }

        function updateConditionAndSortDropdowns(tableName) {
            try {
                const columnsInfo = db.exec(`PRAGMA table_info(${tableName})`);
                const conditionColumn = document.getElementById('conditionColumn');
                const sortColumn = document.getElementById('sortColumn');
                
                // Clear existing options
                conditionColumn.innerHTML = '<option value="">-- Select Column --</option>';
                sortColumn.innerHTML = '<option value="">-- Select Column --</option>';
                
                if (columnsInfo.length && columnsInfo[0].values.length) {
                    columnsInfo[0].values.forEach(row => {
                        const option1 = document.createElement('option');
                        option1.value = row[1];
                        option1.textContent = row[1];
                        conditionColumn.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = row[1];
                        option2.textContent = row[1];
                        sortColumn.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error("Error updating condition and sort dropdowns:", error);
            }
        }

        function addCondition(logicalOperator) {
            const column = document.getElementById('conditionColumn').value;
            const operator = document.getElementById('conditionOperator').value;
            const value = document.getElementById('conditionValue').value;
            
            if (!column) {
                updateStatus("Please select a column for the condition.");
                return;
            }
            
            if (operator !== 'IS NULL' && operator !== 'IS NOT NULL' && !value) {
                updateStatus("Please enter a value for the condition.");
                return;
            }
            
            const condition = {
                column,
                operator,
                value,
                logicalOperator: queryBuilderConditions.length > 0 ? logicalOperator : null
            };
            
            queryBuilderConditions.push(condition);
            updateConditionsList();
            generateQueryBuilderSql();
            
            // Clear input fields
            document.getElementById('conditionValue').value = '';
        }

        function updateConditionsList() {
            const conditionsList = document.getElementById('conditionsList');
            conditionsList.innerHTML = '';
            
            queryBuilderConditions.forEach((condition, index) => {
                if (condition.logicalOperator) {
                    const operatorDiv = document.createElement('div');
                    operatorDiv.className = 'logical-operator';
                    operatorDiv.textContent = condition.logicalOperator;
                    conditionsList.appendChild(operatorDiv);
                }
                
                const conditionDiv = document.createElement('div');
                conditionDiv.className = 'condition-item';
                
                let conditionText = `${condition.column} ${condition.operator}`;
                if (condition.operator !== 'IS NULL' && condition.operator !== 'IS NOT NULL') {
                    conditionText += ` ${condition.value}`;
                }
                
                conditionDiv.innerHTML = `
                    <span>${conditionText}</span>
                    <button class="text-red-600" onclick="removeCondition(${index})">×</button>
                `;
                
                conditionsList.appendChild(conditionDiv);
            });
        }

        function removeCondition(index) {
            queryBuilderConditions.splice(index, 1);
            updateConditionsList();
            generateQueryBuilderSql();
        }

        function addSort() {
            const column = document.getElementById('sortColumn').value;
            const direction = document.getElementById('sortDirection').value;
            
            if (!column) {
                updateStatus("Please select a column for sorting.");
                return;
            }
            
            const sort = {
                column,
                direction
            };
            
            queryBuilderSorts.push(sort);
            updateSortsList();
            generateQueryBuilderSql();
        }

        function updateSortsList() {
            const sortList = document.getElementById('sortList');
            sortList.innerHTML = '';
            
            queryBuilderSorts.forEach((sort, index) => {
                const sortDiv = document.createElement('div');
                sortDiv.className = 'condition-item';
                sortDiv.innerHTML = `
                    <span>${sort.column} ${sort.direction}</span>
                    <button class="text-red-600" onclick="removeSort(${index})">×</button>
                `;
                
                sortList.appendChild(sortDiv);
            });
        }

        function removeSort(index) {
            queryBuilderSorts.splice(index, 1);
            updateSortsList();
            generateQueryBuilderSql();
        }

        function generateQueryBuilderSql() {
            if (!selectedTable) {
                document.getElementById('generatedSql').value = '-- Select a table first';
                return;
            }
            
            let sql = 'SELECT * FROM ' + selectedTable;
            
            // Add WHERE clause if there are conditions
            if (queryBuilderConditions.length > 0) {
                sql += ' WHERE ';
                
                queryBuilderConditions.forEach((condition, index) => {
                    if (index > 0 && condition.logicalOperator) {
                        sql += ` ${condition.logicalOperator} `;
                    }
                    
                    sql += `${condition.column} ${condition.operator}`;
                    
                    if (condition.operator !== 'IS NULL' && condition.operator !== 'IS NOT NULL') {
                        // Add quotes for text values
                        const isNumeric = !isNaN(condition.value) && condition.value !== '';
                        sql += isNumeric ? ` ${condition.value}` : ` '${condition.value}'`;
                    }
                });
            }
            
            // Add ORDER BY clause if there are sorts
            if (queryBuilderSorts.length > 0) {
                sql += ' ORDER BY ';
                
                queryBuilderSorts.forEach((sort, index) => {
                    if (index > 0) {
                        sql += ', ';
                    }
                    
                    sql += `${sort.column} ${sort.direction}`;
                });
            }
            
            sql += ';';
            
            document.getElementById('generatedSql').value = sql;
        }

        function useGeneratedSql() {
            const generatedSql = document.getElementById('generatedSql').value;
            document.getElementById(`sqlQuery${currentQueryTab}`).value = generatedSql;
            switchTab('sql');
            updateStatus("Generated SQL copied to query editor.");
        }

        function executeGeneratedSql() {
            const generatedSql = document.getElementById('generatedSql').value;
            document.getElementById(`sqlQuery${currentQueryTab}`).value = generatedSql;
            executeQuery();
        }

        // Chart Functions
        function updateChartTableList() {
            try {
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                const chartTable = document.getElementById('chartTable');
                
                // Clear existing options
                chartTable.innerHTML = '<option value="">-- Select Table --</option>';
                
                if (tables.length && tables[0].values.length) {
                    tables[0].values.forEach(row => {
                        const option = document.createElement('option');
                        option.value = row[0];
                        option.textContent = row[0];
                        chartTable.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error updating chart table list:", error);
            }
        }

        function updateChartColumns() {
            const tableName = document.getElementById('chartTable').value;
            const labelColumn = document.getElementById('labelColumn');
            const dataColumn = document.getElementById('dataColumn');
            
            // Clear existing options
            labelColumn.innerHTML = '<option value="">-- Select Column --</option>';
            dataColumn.innerHTML = '<option value="">-- Select Column --</option>';
            
            if (!tableName) return;
            
            try {
                const columnsInfo = db.exec(`PRAGMA table_info(${tableName})`);
                
                if (columnsInfo.length && columnsInfo[0].values.length) {
                    columnsInfo[0].values.forEach(row => {
                        const option1 = document.createElement('option');
                        option1.value = row[1];
                        option1.textContent = row[1];
                        labelColumn.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = row[1];
                        option2.textContent = row[1];
                        dataColumn.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error("Error updating chart columns:", error);
            }
        }

        function generateChart() {
            const tableName = document.getElementById('chartTable').value;
            const labelColumn = document.getElementById('labelColumn').value;
            const dataColumn = document.getElementById('dataColumn').value;
            const chartType = document.getElementById('chartType').value;
            
            if (!tableName || !labelColumn || !dataColumn) {
                document.getElementById('chartError').textContent = 'Please select a table and both label and data columns.';
                document.getElementById('chartError').classList.remove('hidden');
                return;
            }
            
            try {
                const results = db.exec(`SELECT ${labelColumn}, ${dataColumn} FROM ${tableName}`);
                
                if (!results || !results[0] || !results[0].values.length) {
                    document.getElementById('chartError').textContent = 'No data available for chart.';
                    document.getElementById('chartError').classList.remove('hidden');
                    return;
                }
                
                const labels = [];
                const data = [];
                
                results[0].values.forEach(row => {
                    labels.push(row[0]);
                    data.push(row[1]);
                });
                
                // Check if data is numeric for certain chart types
                const isNumericData = data.every(value => !isNaN(parseFloat(value)));
                
                if ((chartType === 'bar' || chartType === 'line' || chartType === 'scatter') && !isNumericData) {
                    document.getElementById('chartError').textContent = 'Selected chart type requires numeric data. Please choose a different chart type or data column.';
                    document.getElementById('chartError').classList.remove('hidden');
                    return;
                }
                
                // Clear any previous error
                document.getElementById('chartError').classList.add('hidden');
                
                // Destroy previous chart if it exists
                if (chart) {
                    chart.destroy();
                }
                
                // Create new chart
                const ctx = document.getElementById('dataChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${dataColumn} by ${labelColumn}`,
                            data: isNumericData ? data.map(Number) : data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                updateStatus("Chart generated successfully.");
            } catch (error) {
                document.getElementById('chartError').textContent = 'Error generating chart: ' + error.message;
                document.getElementById('chartError').classList.remove('hidden');
                updateStatus("Error generating chart: " + error.message);
            }
        }

        function clearChart() {
            if (chart) {
                chart.destroy();
                chart = null;
            }
            document.getElementById('chartError').classList.add('hidden');
            updateStatus("Chart cleared.");
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initDB();
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.getElementById('themeSelector').value = savedTheme;
            changeTheme(savedTheme);
            
            // Set up keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    executeQuery();
                }
            });
        });
    </script>
</body>
</html>
<!-- rewrite the code for chart it should dynamic drop down box for user created tables ok -->